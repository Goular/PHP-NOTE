# 电子商城第七天

### 模型文件的存放位置[前台与后面都存在model的内容 ]
<pre>
扩展：模型文件的存放位置，三种方法：
1.所有的模型都放到后台，以后前台也到后台取模型【我们用这种】：如：
$catModel = D(‘Admin/Category’);   // 生成Admin模块下的Category
2.后台用的放到后台模块，前台用的放到前台模块。
3.在Common模块下创建公共的模型，把公共的代码放到这个模型中，前后台特有的方法在前后模块再各个单独继承这个公共的模型
</pre>

### 同一个生命周期的方法中使用使用的方法中还有static，静态变量的，重复构造不会重新置于空，我们需要使用一个标识来清除原本的内容，避免影响第二次调用的数据，多用于递归
<pre>
    /**
     *  仅仅返回以为数组的子类分类ID
     */
    public function getChildrenOnlyNumber($catId = 0)
    {
        //取出所有的分类
        $data = $this->select();
        //递归同时遍历所有的分类，并从中挑选指定ID的后代分类ID
        return $this->__getChildrenOnlyNumber($data, $catId,true);
    }

	/**
     * 递归算法，规矩全部的商品分类，返回一维的分类的排序信息，即父类子类会以同一纬度进行有序展示
     * @param $catId
     * @param $data
     * @return array
     */
    private function __getChildrenOnlyNumber($data, $catId = 0, $flag = false)
    {
        //定义函数静态变量(这个静态区域仅限于函数范围内)
        static $_ret = array();//static创建的函数变量创建一次
        if ($flag) $_ret = array();
        foreach ($data as $key => $value) {
            if ($catId == $value['parent_id']) {
                $_ret[] = $value['id'];
                $this->__getChildren($data, $value['id']);
            }
        }
        return $_ret;
    }	
</pre>

### 页面静态缓存
<pre>
	静态规则定义
	静态规则的定义方式如下：
	'HTML_CACHE_ON'     =>    true, // 开启静态缓存
	'HTML_CACHE_TIME'   =>    60,   // 全局静态缓存有效期（秒）
	'HTML_FILE_SUFFIX'  =>    '.shtml', // 设置静态缓存文件后缀
	'HTML_CACHE_RULES'  =>     array(  // 定义静态缓存规则
		// 定义格式1 数组方式
		'静态地址'    =>     array('静态规则', '有效期', '附加规则'), 
		// 定义格式2 字符串方式
		'静态地址'    =>     '静态规则', 
	)
	
	执行后会在顶级创建一个名称为"HTML"的文件夹，里面放置就是我们的静态化的页面
</pre>

### 雪崩问题解决
<pre>
	ThinkPHP在所有执行读取缓存页面的时候都会到Think\Storage的ReadHtmlCacheBehaviour 【在Behaviour文件夹中】执行run()方法，我们只需要生成静态化页面的时候
	加一把文件锁（当然仅能是单一服务器才能使用文件锁，不然就只能使用其他的锁办法）

	静态缓存读取
	
	生成静态缓存的雪崩问题：如果网站的并发量在100【每秒有100个刷新】，在缓存页面失效的一瞬间，100个并发同时进入到后端数据库有可能让数据库崩溃。
	解决TP中静态缓存的雪崩问题：【生成静态缓存页时加锁，在缓存失效时只让一个客户端进入控制器】
	
	
	文件锁要采用全局变量的方法，因为PHP的方法变量的参数时有效期是脚本周期
	
	如果静态页不存在或者已经过期就向后执行 --》 只让一个客户端通过这里生成静态页，其他客户端阻塞在这等待第一个客户端生成静态页

	文件锁的关闭会在执行脚本周期内容的最好一并关闭	
</pre>

### 面包屑内容
<pre>
	这里由于我当时设置商品的时候只能输入主分类，所以会产生不能出现面包屑往上找的问题，因为主分类已经是末端了，所以可以在数据表中进行修改来测试
	我们可以以后实际部署的时候修改商品的主分类变为可以选择多级分类的内容

	其实就是通过商品的分类往上推到然后进行倒序显示即可
</pre>


### 最近浏览历史
<pre>

	使用cookie来保存浏览过的内容IDS，同时使用ajax来做访问的依据，使用js来控制cookie
	
	历史浏览使用ajax来处理比较好，因为没有登录也是可以查看到浏览记录，这样数据库就不好保存他的浏览记录，而php后台创建页面显示，
	这样要让用户来按F5刷新，这样是极其不友好的操作，使用ajax能够提高用户体感
	
</pre>